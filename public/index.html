<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stagehand Scraper Live Logs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@2.2.1/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.2.1/dist/flowbite.min.js"></script>
  <style>
    .mono-font { font-family: 'Monaco', 'Menlo', 'Consolas', monospace; }
    .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #f7fafc; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
    
    /* Prevent horizontal overflow */
    body { overflow-x: hidden; }
    .max-w-screen { max-width: 100vw; }
    
    /* JSON display improvements */
    .json-display {
      max-width: 100%;
      word-wrap: break-word;
      white-space: pre-wrap;
      overflow-wrap: break-word;
    }
    
    /* Responsive layout */
    @media (max-width: 768px) {
      .flex.h-screen { flex-direction: column; }
      .w-80 { width: 100%; height: auto; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="flex h-screen max-w-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
      <div class="p-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Patterns</h3>
      </div>
      <div class="flex-1 overflow-y-auto scrollbar-thin">
        <div id="patternsList" class="p-2"></div>
        <div id="patternDetails" class="p-4 border-t border-gray-200" style="display: none;">
          <h4 class="text-md font-medium text-gray-900 mb-3">Pattern Details</h4>
          <div id="patternStats" class="mb-4"></div>
          <h5 class="text-sm font-medium text-gray-700 mb-2">Recent Observations</h5>
          <div id="patternObservations" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
      <!-- Header -->
      <div class="bg-white border-b border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Stagehand Scraper</h1>
            <p class="text-sm text-gray-600">Live Logs & Schema Generation</p>
          </div>
          <div class="flex items-center space-x-4">
            <label class="flex items-center">
              <input type="checkbox" id="autoMode" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2" checked>
              <span class="ml-2 text-sm text-gray-700">Auto-follow current request</span>
            </label>
            <a href="/docs" target="_blank" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              API Docs
            </a>
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="flex-1 flex flex-col p-4 space-y-4 min-w-0 overflow-hidden">
        <!-- Active Request Info -->
        <div class="bg-white rounded-lg border border-gray-200 p-4">
          <div id="activeInfo" class="text-sm text-gray-600">Auto-following latest request...</div>
          <button id="clearRequest" onclick="clearActiveRequest()" class="mt-2 px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded transition-colors" style="display: none;">
            Clear & Auto-follow
          </button>
        </div>

        <!-- Requests List -->
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="p-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Recent Requests</h3>
          </div>
          <div id="requests" class="max-h-64 overflow-y-auto scrollbar-thin"></div>
        </div>

        <!-- Schema Panel -->
        <div id="schemaPanel" class="bg-white rounded-lg border border-gray-200 min-w-0" style="display: none;">
          <div class="p-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Generated Schema</h3>
          </div>
          <div class="p-4 min-w-0">
            <div id="schemaStatus" class="mb-4"></div>
            <div id="schemaFields" class="mb-4"></div>
            <div id="schemaJson" class="min-w-0"></div>
          </div>
        </div>

        <!-- Logs Output -->
        <div class="flex-1 bg-white rounded-lg border border-gray-200 flex flex-col min-w-0">
          <div class="p-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Live Logs</h3>
          </div>
          <pre id="out" class="flex-1 p-4 bg-gray-900 text-green-400 mono-font text-sm leading-relaxed overflow-auto scrollbar-thin min-w-0"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    const out = document.getElementById('out');
    const list = document.getElementById('requests');
    const info = document.getElementById('activeInfo');
    const autoMode = document.getElementById('autoMode');
    const patternsList = document.getElementById('patternsList');
    const patternDetails = document.getElementById('patternDetails');
    const patternStats = document.getElementById('patternStats');
    const patternObservations = document.getElementById('patternObservations');
    const schemaPanel = document.getElementById('schemaPanel');
    const schemaStatus = document.getElementById('schemaStatus');
    const schemaFields = document.getElementById('schemaFields');
    const schemaJson = document.getElementById('schemaJson');

    const url = new URL(location.href);
    let requestId = url.searchParams.get('request_id') || null;
    let selectedPattern = url.searchParams.get('pattern') || null;

    const catalog = new Map();
    const requestStatuses = new Map(); // Track request statuses: {status, result, error, timestamp}

    function catalogRequest(d) {
      const id = d.request_id;
      if (!catalog.has(id)) {
        catalog.set(id, { url: d.url, prompt: d.prompt, lastTimestamp: d.timestamp });
      } else {
        const existing = catalog.get(id);
        existing.lastTimestamp = d.timestamp;
        catalog.set(id, existing);
      }
    }

    function renderList() {
      const sorted = Array.from(catalog.entries()).sort((a, b) => new Date(b[1].lastTimestamp) - new Date(a[1].lastTimestamp));
      list.innerHTML = sorted.map(([id, data]) => {
        const status = requestStatuses.get(id);
        let statusBadge = '';
        let statusColor = '';
        
        if (status) {
          switch (status.status) {
            case 'running':
              statusBadge = 'üîÑ RUNNING';
              statusColor = 'text-blue-600';
              break;
            case 'completed':
              statusBadge = '‚úÖ PASS';
              statusColor = 'text-green-600';
              break;
            case 'failed':
              statusBadge = '‚ùå FAIL';
              statusColor = 'text-red-600';
              break;
          }
        }
        
        return `
          <div class="p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors ${id === requestId ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}" onclick="setActiveRequest('${id}', '${data.url}', '${data.prompt}', true)">
            <div class="flex items-center justify-between mb-1">
              <div class="font-mono text-xs text-gray-500">${id}</div>
              ${statusBadge ? `<div class="text-xs font-medium ${statusColor}">${statusBadge}</div>` : ''}
            </div>
            <div class="font-medium text-gray-900 truncate">${data.url}</div>
            <div class="text-sm text-gray-600 mt-1 line-clamp-2">${data.prompt || 'No prompt provided'}</div>
            <div class="text-xs text-gray-500 mt-1">${new Date(data.lastTimestamp).toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })}</div>
          </div>
        `;
      }).join('');
    }

    function setActiveRequest(id, urlHint, promptHint, updateUrl) {
      requestId = id;
      info.textContent = `Following request ${id}`;
      document.getElementById('clearRequest').style.display = 'inline-block';
      if (updateUrl) {
        const u = new URL(location.href);
        u.searchParams.set('request_id', id);
        history.pushState({}, '', u);
      }
      if (id && (!catalog.has(id))) catalog.set(id, { url: urlHint, prompt: promptHint, lastTimestamp: new Date().toISOString() });
      renderList();
      connect();
      
      // Show detailed results if available
      const status = requestStatuses.get(id);
      if (status) {
        showRequestDetails(id, status);
      }
    }

    function clearActiveRequest() {
      requestId = null;
      info.textContent = 'Auto-following latest request';
      document.getElementById('clearRequest').style.display = 'none';
      const u = new URL(location.href);
      u.searchParams.delete('request_id');
      history.pushState({}, '', u);
      renderList();
      connect();
    }

    function connect() {
      if (window.ws) try { window.ws.close(); } catch {}
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      // Always connect to the global logs endpoint to see all requests for the Recent Requests list
      const wsUrl = '/logs';
      const ws = new WebSocket(proto + '://' + location.host + wsUrl);
      window.ws = ws;
      out.textContent='';
      info.textContent = requestId ? `Following request ${requestId}` : 'Auto-following latest request';
      
      ws.onopen = () => {
        console.log('WebSocket connected successfully');
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
      
      ws.onclose = (event) => {
        console.log('WebSocket closed:', event.code, event.reason);
        // Attempt to reconnect after 3 seconds
        setTimeout(() => {
          console.log('Attempting to reconnect WebSocket...');
          connect();
        }, 3000);
      };
      
      ws.onmessage = (e) => {
        try {
          const m = JSON.parse(e.data);
          if (m.type === 'log') {
            const d = m.data;
            if (d.request_id) {
              catalogRequest(d);
              renderList(); // Update the requests list when new requests come in
            }
            
            // Only show logs in the output if they match the current requestId (or if no requestId is set)
            if (!requestId || d.request_id === requestId) {
              out.textContent += `[${new Date(d.timestamp).toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })}] ${d.level} ${d.message} ${d.url||''} ${d.details||''}\n`;
              out.scrollTop = out.scrollHeight;
            }
            
            // Auto-follow new requests when in auto mode
            if (!requestId && autoMode.checked && d.request_id) {
              setActiveRequest(d.request_id, d.url, d.prompt, false);
            }
          } else if (m.type === 'error') {
            out.textContent += `[ERROR] ${m.error}\n`;
            out.scrollTop = out.scrollHeight;
          }
          // Handle schema events
          else if (m.type === 'schema_generation_start') {
            handleSchemaGenerationStart(m);
          } else if (m.type === 'schema_description') {
            handleSchemaDescription(m);
          } else if (m.type === 'schema_json') {
            handleSchemaJson(m);
          } else if (m.type === 'schema_generation_error') {
            handleSchemaError(m);
          } else if (m.type === 'extraction_complete') {
            handleExtractionComplete(m);
          } else if (m.type === 'extraction_error') {
            handleExtractionError(m);
          } else if (m.type === 'request_status') {
            handleRequestStatus(m);
          }
        } catch {
          out.textContent += e.data + '\n';
        }
      };
    }

    // Pattern management functions
    async function loadPatterns() {
      try {
        const response = await fetch('/observations/patterns');
        const data = await response.json();
        renderPatterns(data.patterns || []);
      } catch (error) {
        console.error('Failed to load patterns:', error);
      }
    }

    function renderPatterns(patterns) {
      patternsList.innerHTML = patterns.map(pattern => `
        <div class="pattern-item p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors ${pattern.pattern === selectedPattern ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}" 
             onclick="selectPattern('${pattern.pattern}')">
          <div class="pattern-name text-sm font-medium text-gray-900 truncate">${pattern.pattern}</div>
          <div class="pattern-stats text-xs text-gray-600">
            <span class="success-rate">${pattern.success_rate}%</span> success ‚Ä¢ 
            ${pattern.total_observations} observations
          </div>
        </div>
      `).join('');
    }

    async function selectPattern(pattern) {
      selectedPattern = pattern;
      const url = new URL(location.href);
      url.searchParams.set('pattern', pattern);
      history.pushState({}, '', url);
      
      // Update UI
      document.querySelectorAll('.pattern-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'border-l-4', 'border-l-blue-500');
      });
      event.target.closest('.pattern-item').classList.add('bg-blue-50', 'border-l-4', 'border-l-blue-500');
      
      await loadPatternDetails(pattern);
    }

    async function loadPatternDetails(pattern) {
      try {
        const response = await fetch(`/observations?pattern=${encodeURIComponent(pattern)}&limit=10`);
        const data = await response.json();
        
        // Show pattern details
        patternDetails.style.display = 'block';
        
        // Render stats
        patternStats.innerHTML = `
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-gray-50 p-3 rounded-lg">
              <div class="text-2xl font-bold text-gray-900">${data.aggregate?.total_observations || 0}</div>
              <div class="text-sm text-gray-600">Total Observations</div>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <div class="text-2xl font-bold text-green-600">${data.aggregate?.success_rate || 0}%</div>
              <div class="text-sm text-gray-600">Success Rate</div>
            </div>
          </div>
        `;
        
        // Render observations
        patternObservations.innerHTML = data.observations.map(obs => `
          <div class="observation-item p-2 bg-gray-50 rounded border-l-4 ${obs.outcome === 'success' ? 'border-l-green-500' : obs.outcome === 'partial' ? 'border-l-yellow-500' : 'border-l-red-500'}">
            <div class="text-xs font-medium text-gray-900">${obs.action_type}</div>
            <div class="text-xs text-gray-600">${obs.outcome} ‚Ä¢ ${new Date(obs.timestamp).toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })}</div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Failed to load pattern details:', error);
      }
    }

    window.addEventListener('popstate', () => {
      const u = new URL(location.href);
      requestId = u.searchParams.get('request_id');
      selectedPattern = u.searchParams.get('pattern');
      if (selectedPattern) {
        loadPatternDetails(selectedPattern);
      } else {
        patternDetails.style.display = 'none';
      }
    });

    // Schema event handlers
    function handleSchemaGenerationStart(event) {
      if (event.request_id === requestId) {
        schemaPanel.style.display = 'block';
        schemaStatus.innerHTML = `
          <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-yellow-800 font-medium">Generating schema from natural language...</span>
          </div>
        `;
        schemaFields.innerHTML = '';
        schemaJson.innerHTML = '';
      }
    }

    function handleSchemaDescription(event) {
      if (event.request_id === requestId) {
        schemaStatus.innerHTML = `
          <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg">
            <svg class="w-5 h-5 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-green-800 font-medium">Schema description generated</span>
          </div>
        `;
        
        const fieldsHtml = event.description.map(field => `
          <div class="bg-white border border-gray-200 rounded-lg p-3 mb-2 border-l-4 border-l-blue-500">
            <div class="font-semibold text-blue-600 text-sm">${field.name}</div>
            <div class="text-xs text-gray-600 mt-1">Type: <span class="font-medium">${field.type}</span></div>
            ${field.description ? `<div class="text-xs text-gray-700 mt-1">${field.description}</div>` : ''}
          </div>
        `).join('');
        
        schemaFields.innerHTML = fieldsHtml;
      }
    }

    function handleSchemaJson(event) {
      if (event.request_id === requestId) {
        const formattedJson = JSON.stringify(event.jsonSchema, null, 2);
        schemaJson.innerHTML = `
          <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto max-w-full">
            <pre class="text-green-400 mono-font text-xs json-display">${formattedJson}</pre>
          </div>
        `;
      }
    }

    function handleSchemaError(event) {
      if (event.request_id === requestId) {
        schemaStatus.innerHTML = `
          <div class="flex items-center p-3 bg-red-50 border border-red-200 rounded-lg">
            <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-red-800 font-medium">Schema generation failed: ${event.error}</span>
          </div>
        `;
        const formattedFallback = JSON.stringify(event.fallbackSchema, null, 2);
        schemaJson.innerHTML = `
          <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto max-w-full">
            <pre class="text-red-400 mono-font text-xs json-display">${formattedFallback}</pre>
          </div>
        `;
      }
    }

    function handleExtractionComplete(event) {
      if (event.request_id === requestId) {
        schemaStatus.innerHTML += `
          <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg mt-2">
            <svg class="w-5 h-5 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-green-800 font-medium">Extraction completed - ${event.dataCount} items extracted</span>
          </div>
        `;
        
        // Display extracted data if available
        if (event.extractedData) {
          const dataStr = JSON.stringify(event.extractedData, null, 2);
          schemaJson.innerHTML = `
            <div class="mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-2">üìÑ Extracted Data:</h4>
              <pre class="bg-gray-50 p-3 rounded border text-xs overflow-x-auto json-display">${dataStr}</pre>
            </div>
          `;
        }
      }
    }

    function handleExtractionError(event) {
      if (event.request_id === requestId) {
        schemaStatus.innerHTML += `
          <div class="flex items-center p-3 bg-red-50 border border-red-200 rounded-lg mt-2">
            <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-red-800 font-medium">Extraction failed: ${event.error}</span>
          </div>
        `;
      }
    }

    function handleRequestStatus(event) {
      // Store the request status
      requestStatuses.set(event.request_id, {
        status: event.status,
        result: event.result,
        error: event.error,
        timestamp: event.timestamp
      });
      
      // Update the requests list to reflect the new status
      renderList();
    }

    function showRequestDetails(requestId, status) {
      // Clear existing schema content
      schemaStatus.innerHTML = '';
      schemaFields.innerHTML = '';
      schemaJson.innerHTML = '';
      
      // Show status
      let statusColor = '';
      let statusIcon = '';
      let statusText = '';
      
      switch (status.status) {
        case 'running':
          statusColor = 'bg-blue-50 border-blue-200';
          statusIcon = 'üîÑ';
          statusText = 'Request is running...';
          break;
        case 'completed':
          statusColor = 'bg-green-50 border-green-200';
          statusIcon = '‚úÖ';
          statusText = 'Request completed successfully';
          break;
        case 'failed':
          statusColor = 'bg-red-50 border-red-200';
          statusIcon = '‚ùå';
          statusText = 'Request failed';
          break;
      }
      
      schemaStatus.innerHTML = `
        <div class="flex items-center p-3 ${statusColor} border rounded-lg">
          <span class="text-lg mr-3">${statusIcon}</span>
          <span class="font-medium">${statusText}</span>
        </div>
      `;
      
      // Show results or errors
      if (status.status === 'completed' && status.result) {
        // Show extracted data
        if (status.result.finalContent) {
          schemaJson.innerHTML = `
            <div class="mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-2">üìÑ Extracted Content:</h4>
              <pre class="bg-gray-50 p-3 rounded border text-xs overflow-x-auto json-display">${status.result.finalContent}</pre>
            </div>
          `;
        } else if (status.result.extractedData) {
          const dataStr = JSON.stringify(status.result.extractedData, null, 2);
          schemaJson.innerHTML = `
            <div class="mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-2">üìÑ Extracted Data:</h4>
              <pre class="bg-gray-50 p-3 rounded border text-xs overflow-x-auto json-display">${dataStr}</pre>
            </div>
          `;
        }
      } else if (status.status === 'failed' && status.error) {
        // Show error details
        schemaJson.innerHTML = `
          <div class="mt-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">‚ùå Error Details:</h4>
            <pre class="bg-red-50 p-3 rounded border text-xs overflow-x-auto json-display">${status.error}</pre>
          </div>
        `;
      }
    }

    // Initialize
    loadPatterns();
    renderList(); // Initialize the requests list
    connect();
    
    // Auto-refresh patterns every 30 seconds
    setInterval(loadPatterns, 30000);
  </script>
</body>
</html>